# url 输入做了什么

## 前置知识点

需要各个进程之间的相互配合。

浏览器进程：用户交互、子进程管理和文件储存

网络进程：向浏览器进程和渲染进程提供网络下载等功能

渲染进程：从网络上下载的 HTML、Javascript、css、图片等资源解析为显示和可交互的页面

## 整个过程

用户发出 URL 请求到页面开始解析的这个过程，叫做导航

1、浏览器进程接收到用户输入的 URL 请求，浏览器进程将该 URL 转发给网络进程

2、网络进程中发起真正的 URL 请求

3、浏览器进程接收到网络进程的响应头数据之后，发送“提交导航”消息到渲染进程

4、渲染进程接收到“提交导航”的消息之后，开始准备接收 HTML 数据，（直接和网络进程建立数据管道

5、渲染进程会向浏览器进程“确认提交”，告诉浏览器进程：“已经准备好接受和解析页面数据了”

6、浏览器进程接收到渲染进程“提交文档”的消息之后，开始移除之前旧的文档，更新浏览器进程中的页面状态

```
          URL请求                            发起请求
浏览器进程 ------------------------> 网络进程 ------->
          <------------------------    |
    |      相应数据                     |
    |                                  |
提交 |                                 |
文档 | 提交导航                          |
    |                                  |
渲染进程                              渲染进程

```

## 输入 URL 到页面展示

1、用户输入

判断是否是搜索内容

- 是，使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL
- 否，"time.geekbang.org"符合 HRL 规则，会根据规则，把这段内容加上协议，合称为完整的 URL

用户输入关键字并键入回车之后，意味着当前页面即将要被替换成新的页面，在这个流程之前，浏览器会给当前页面一次执行 beforeunload 事件的机会。

beforeunload 事件允许页面在退出之前执行一些数据清理操作，可以询问用户是否要离开当前页面，比如当前页面可能有未提交完成的表单情况，因此用户可以通过 beforeunload 事件来取消导航，让浏览器不再执行任何后续工作。

页面没有监听 beforeunload 事件或统一了继续后续流程

2、URL 请求过程

页面资源请求过程。浏览器进程会通过进程间通信把 URL 发送至网络进程。由网络进程发送请求

是否有缓存
有: 直接返回资源给浏览器进程
无：网络请求过程

网络请求过程

HTTP
DNS 解析获取请求域名的服务器 IP 地址
HTTPS
建立 TLS 连接

1）、重定向
返回 301 或者 302，说明服务器需要浏览器重定向到其他 HRL，网络进程会从响应头的 Location 字段里面读取重定向的地址，重新发起请求

```javascript
curl -I http://time.geekbang.org/

HTTP/1.1 302 Found
Date: Wed, 14 Apr 2021 13:26:59 GMT
Content-Type: text/html
Content-Length: 154
Connection: keep-alive
Location: https://time.geekbang.org/
Via: HTTP/1.1 SLB.47

```

在导航过程中，如果服务器相应行的状态包含了 301、302 一类的跳转信息，浏览器会跳转到新的地址继续导航；如果相应行是 200，那么表示浏览器可以继续处理该请求

（2）、响应数据类型处理

URL 请求的数据类型，根据 Content-Type 区分 响应体数据是什么类型。

如果是下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程到此结束
如果是 HTML，那么浏览器会继续进行导航流程

（3）、准备渲染进程

会为每个页面分配一个渲染进程，每打开一个新页面就会配套创建一个新的渲染进程，也有例外，浏览器会让多个页面直接运行在同一个渲染进程中。

同一站点：同根域名+协议

```javascript

https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080

```

渲染进程策略：

- 通常情况下，打开新的页面都会使用单独的渲染进程
- 如果从 A 页面打开 B 页面，且 A 和 B 都属于同一站点的话，那么 B 页面复用 A 页面的渲染进程

（4）提交文档
浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程

浏览器接收到网络进程的响应头数据之后，向渲染进程发起“提交文档”的消息

渲染进程接收到之后，会和网络进程建立传输数据的管道

传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程

浏览器进程收到“确认提交”的消息之后，会更新浏览器界面状态，包括安全状态、地址栏 URL、前进后退的历史状态，并更新 WEB 页面

（5）渲染阶段
一旦文档被提交，渲染进程便开始页面解析和子资源加载了。
