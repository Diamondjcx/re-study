# 闭包

```javascript
for (var i = 0; i < 5; i++) {
  setTimeout(function () {
    console.log(new Date(), i)
  }, 1000)
}

console.log(new Date(), i)
```

输出 5,5,5,5,5,5

循环里面的 5 立即输出，不会进行 1s 的时间间隔；这些定时器都会在 1 秒之后触发，而循环完的输出是立即执行的

## 追问 1

想要输出 5 -> 0,1,2,3,4

1.立即执行

```javascript
for (var i = 0; i < 5; i++) {
  ;(function (j) {
    // j = i
    setTimeout(function () {
      console.log(new Date(), j)
    }, 1000)
  })(i)
}

console.log(new Date(), i)
```

2.`setTimeout` 文档

```javascript
for (var i = 0; i < 5; i++) {
  setTimeout(
    function (j) {
      console.log(new Date(), j)
    },
    1000,
    i
  )
}

console.log(new Date(), i)
```

3.JS 中基本类型（Primitive Type）的参数传递是按值传递（Pass by Value）的特征

```javascript
var output = function (i) {
  setTimeout(function () {
    console.log(new Date(), i)
  }, 1000)
}

for (var i = 0; i < 5; i++) {
  output(i) // 这里传过去的 i 值被复制了
}

console.log(new Date(), i)
```

4.ES6 的 let

```javascript
for (let i = 0; i < 5; i++) {
  setTimeout(function () {
    console.log(new Date(), i)
  }, 1000)
}

console.log(new Date(), i)
```

## 追问 2

想要输出 0 -> 1 -> 2 -> 3 -> 4 -> 5 中间间隔 1s

1.使用回调函数

```javascript
for (var i = 0; i < 5; i++) {
  ;(function (j) {
    setTimeout(function () {
      console.log(new Date(), j)
    }, 1000 * j) // 这里修改 0~4 的定时器时间
  })(i)
}

setTimeout(function () {
  // 这里增加定时器，超时设置为 5 秒
  console.log(new Date(), i)
}, 1000 * i)
```

2.使用 promise

```javascript
const tasks = [] // 这里存放异步操作的 Promise
const output = (i) =>
  new Promise((resolve) => {
    setTimeout(() => {
      console.log(new Date(), i)
      resolve()
    }, 1000 * i)
  })

// 生成全部的异步操作
for (var i = 0; i < 5; i++) {
  tasks.push(output(i))
}

// 异步操作完成之后，输出最后的 i
Promise.all(tasks).then(() => {
  setTimeout(() => {
    console.log(new Date(), i)
  }, 1000)
})
```

3.`async/await`

```javascript
// 模拟其他语言中的 sleep，实际上可以是任何异步操作
const sleep = (timeountMS) =>
  new Promise((resolve) => {
    setTimeout(resolve, timeountMS)
  })

;(async () => {
  // 声明即执行的 async 函数表达式
  for (var i = 0; i < 5; i++) {
    if (i > 0) {
      await sleep(1000)
    }
    console.log(new Date(), i)
  }

  await sleep(1000)
  console.log(new Date(), i)
})()
```
