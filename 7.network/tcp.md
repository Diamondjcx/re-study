# TCP 三次握手 四次挥手

TCP 提供了一种可靠的、面向连接、字节流、传输层的服务

如何保证可靠呢？ 三次握手 四次挥手

为了保证建立安全可靠的连接

协议 连接性 双⼯性 可靠性 有序性 有界性 拥塞控制 传输速度 量级 头部⼤⼩
TCP ⾯向连接 (Connection oriented) 全双⼯(1:1) 可靠(重传机 制) 有序(通过 SYN 排 序) ⽆, 有粘包 情况 有 慢 低 20~60 字节

UDP ⽆连接 (Connection less) n:m 不可靠 (丢包后 数据丢 失) ⽆序 有消息边 界, ⽆粘包 ⽆ 快 ⾼ 8 字节

## 三次握手

第一次是由客户端发起，客户端会向服务端发送一个报文，在报文里面，SIN 位标志为 1，服务端收到这个报文之后就知道，客户端要向我发起一个新的连接，

于是服务端就向客户端发送一个确认消息包，在这个消息包里面，ACK 位置 1，以上两次连接之后，其实客户端已经知道了：我既能和服务端发送消息，又可以收到服务端的消息，但是对于服务端而言，两次握手是不够的，到目前为止，对于服务端只知道一件事情，客户端给我的消息我能收到，但是我发送给客户端的消息，

客户端能不能收到，所以还要进行第三次握手，第三次握手就是，当客户端收到服务端的确认消息包之后，继续给服务端一个回应，也是一个 ACK 为置 1 的确认消息
通过以上三次连接呢，不管是客户端还是服务端都彼此知道既能和对方发送消息，又能收到对方的消息，连接就可以被安全的建立了。

## 四次挥手：

也是由客户端发起，SIN 位置 1，当服务端收到这个消息之后，我就知道了客户端想要和我断开连接了，但是此时服务端不一定能做好准备，因为当客户端发起断开连接的时候
对于服务端而言，极有可能还有未发送完的消息，还要继续发送，所以对于服务端而言，只能对于消息的一个确认，先告诉客户端，我知道你要跟我断开连接了，但是我可能还没有做好准备，需要你等我一下，所以发完确认包之后，

首部格式

TCP 首部数据通常包含 20 个字节

- 1-2：源端口号
- 3-4：目的端口号
- 5-8：32 位序号，tcp 提供全双工服务，两端都有各自的序号。编码：解决网络报乱序的问题
- 9-12：32 位确认序列号。上次成功收到数据字节序号加 1，ack 为 1 才有效。确认号：解决丢包的问题

标识位说明

- ACK:确认标识，连接建立成功后，总为 1，为 1 时确认号有效
- SYN：建立新连接时，该位为 0
- FIN：关闭连接标识

### 三次握手流程

- 客户端发送 SYN,表明要向服务器建立连接，同时带上序列号 ISN
- 服务器返回 ACK（序列号为客户端序列号+1）作为确认。同时发送 SYN 作为应答（SYN 的序列号为服务端唯一的序号）
- 客户端发送 ACK 确认收到回复（序列号为服务端序列号+1）

为什么是三次握手

- tcp 连接是全双工的，数据在两个方向上能同时传递
- 所以要确保双方，同时能发送数据和接收数据
- 第一次客户端---->服务端 服务端接收到数据，证明客户端发送没有问题，服务端接收没有问题
- 第二次服务端---->客户端 客户端收到数据，证明客户端接收没有问题 客户端接收和发送都没有问题
- 第三次客户端---->服务端 服务端接收到数据，证明服务端发送没有问题

为什么是四次挥手

- 因为 tcp 连接是全双工的，数据再两个方向上能同时传递
- tcp 支持半关闭（发送一方接收发送还能接收数据的功能
- 因此每个方向都要单独关闭，且收到关系通知需要发送确认回复

四次挥手流程

- 客户端---->服务端 携带 FIN，表示要单方面关闭数据的传输
- 服务端收到 FIN 后，发送一个 ACK 作为确认（序列号为收到的序列号+1
- 等服务端数据传输完毕，也发送一个 FIN 标识，表示关闭这个方向的数据传输
- 客户端回复 ACK 以确认回复

报文格式---三次握手 四次挥手
