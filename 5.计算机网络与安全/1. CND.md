## what

Content Delivery Network 内容分发网络

天猫超市会把货物提前存储在菜鸟建设在全国各地的本地仓库来减少物流时间
网站也可以预先把内容分发至全国各地的加速节点。

CDN (内容分发网络) 指的是一组分布在各个地区的服务器。这些服务器存储着数据的副本，因此服务器可以根据哪些服务器与用户距离最近，来满足数据的请求。

构建在现有网络基础之上的智能虚拟网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。`CDN` 的关键技术主要有内容存储和分发技术

简单来讲，`CDN`就是根据用户位置分配最近的资源

于是，用户在上网的时候不用直接访问源站，而是访问离他“最近的”一个 CDN 节点，术语叫**边缘节点**，其实就是缓存了源站内容的代理服务器。如下图：

![](https://static.vue-js.com/4f0289f0-b86b-11eb-85f6-6fac77c0c9b3.png)

## 好处：

就近获取所需内容，避免网络拥堵、地域、运营商等因素带来的访问延迟问题，有效提升下载速度、降低响应时间，提供流畅的用户体验

解决因分布、带宽、服务器性能带来的访问延迟问题，适用于站点加速、点播、直播等场景，使用户可就近取得所需内容，解决 Internet 网络拥挤状况，提高用户访问网站的响应速度和成功率。

1、 预先做好货物分发，用时短，同城范围配送公司会增多

CDN 技术消除不同运营商之间互联的瓶颈造成的影响，实现跨运营商的网络加速，保证不同网络中的用户都能得到良好的访问质量。

2、集中式仓库一旦遇到灾害，损失严重，分布不同地区，有效减小自然灾害带来的影响

广泛分布的 CDN 节点之间智能冗余机制，有效预防黑客入侵以及降低各种 DDOS 攻击对网站的影响，同时保证较好的服务质量。

## 工作过程

原始访问过程：

- 1、用户输入 url 域名访问
- 2、浏览器向本地 DNS 服务器请求该域名的解析
- 3、本地 DNS 缓存域名的解析结果
  - 有缓存 则直接响应用户的解析请求
  - 若没有则以迭代方式向整个 DNS 系统请求解析，将结果反馈给浏览器
- 4、浏览器拿到 ip 地址之后，经过 TCP 握手，建立 TCP 连接
- 5、向服务器发起 HTTP 请求
- 6、服务器将用户请求内容传送给浏览器

DNS 访问过程： 加快相应速度

- 1、用户输入 url 域名访问
- 2、浏览器向本地 DNS 服务器请求该域名的解析
- 3、本地 DNS 缓存域名的解析结果
  - 有缓存 则直接响应用户的解析请求
  - 若没有 本地 DNS 系统会将域名解析权交给 CNAME 指向的 CDN 专用 DNS 服务器
- 4、CDN 的 DNS 服务器将 CDN 的全局负载均衡设备 IP 地址返回给用户
- 5、用户向 CDN 的全局负载均衡设备发起 URL 访问请求
- 6、CDN 全局负载均衡设备根据用户 IP 地址，以及用户请求的 URL，选择一台用户所属区域的区域负载均衡设备，并将请求转发到此设备上
- 7、区域负载均衡设备会选择一个最优缓存服务器节点。并从缓存服务器节点处得到缓存服务器的 IP 地址，最终将得到的 IP 地址返回给全局负载均衡设备
  - 根据用户 IP 地址，判断拿一个边缘节点距用户最近
  - 根据用户所请求的 URL 中携带的内容名称，判断哪一个边缘节点上有用户所需内容
  - 查询各个边缘节点当前的负载情况，判断哪一个边缘节点有服务能力
- 8、全局负载均衡设备把服务器的 IP 地址返回给用户
- 9、用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。

## 二、原理分析

在没有应用`CDN`时，我们使用域名访问某一个站点时的路径为

> 用户提交域名 → 浏览器对域名进行解释 →`DNS` 解析得到目的主机的 IP 地址 → 根据 IP 地址访问发出请求 → 得到请求数据并回复

应用`CDN`后，`DNS` 返回的不再是 `IP` 地址，而是一个`CNAME`(Canonical Name ) 别名记录，指向`CDN`的全局负载均衡

`CNAME`实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是`CDN`实现的关键

#### 负载均衡系统

由于没有返回`IP`地址，于是本地`DNS`会向负载均衡系统再发送请求 ，则进入到`CDN`的全局负载均衡系统进行智能调度：

- 看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点
- 看用户所在的运营商网络，找相同网络的边缘节点

- 检查边缘节点的负载情况，找负载较轻的节点
- 其他，比如节点的“健康状况”、服务能力、带宽、响应时间等

结合上面的因素，得到最合适的边缘节点，然后把这个节点返回给用户，用户就能够就近访问`CDN`的缓存代理

整体流程如下图：

![](https://static.vue-js.com/588d7890-b86b-11eb-85f6-6fac77c0c9b3.png)

#### 缓存代理

缓存系统是 `CDN `的另一个关键组成部分，缓存系统会有选择地缓存那些最常用的那些资源

其中有两个衡量`CDN`服务质量的指标：

- 命中率：用户访问的资源恰好在缓存系统里，可以直接返回给用户，命中次数与所有访问次数之比
- 回源率：缓存里没有，必须用代理的方式回源站取，回源次数与所有访问次数之比

缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户

回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，可以有效地减少真正的回源

现在的商业 `CDN`命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上

## CDN 的组成

中心节点就像仓配网络中负责货物调配的总仓，而边缘节点就是负责存储货物的各个城市的本地仓库。

中心节点
中心节点包括 CDN 网管中心和全局负载均衡 DNS 重定向解析系统，负责整个 CDN 网络的分发及管理。

边缘节点
CDN 边缘节点主要指异地分发节点，由负载均衡设备、高速缓存服务器两部分组成。

## CDN 的关键技术

缓存算法
命中率、源服务器压力、POP 节点存储能力

分发能力
IDC 能力和 IDC 策略性分布

负载均衡
最佳路由、响应时间、可用性、服务质量

基于 DNS
负载均衡以 CNAME 实现[to cluster]，智取最优节点服务

缓存点有客户端浏览器缓存、本地 DNS 服务器缓存
缓存内容有 DNS 地址缓存、客户请求内容缓存、动态内容缓存

支持协议
支持协议如静动态加速（图片加速、https 带证书加速）、下载加速、流媒体加速、企业应用加速、手机应用加速

## 应用场景

用户访问量很大的网站、访问内容更新周期比较长

- 电商领域
  加速类型

  - 图片
  - 视频
  - 静态页

- 游戏领域
  加速类型

  - 安装包
  - 补丁

- 移动领域
  加速类型

  - APP 安装包
  - APP 更新包

- 直播领域
  加速类型

  - 视频流

- 点播领域
  加速类型
  - 视频文件
  - 视频分片

## CDN 不足

实时性不太好：远程服务器与复本服务器或缓存服务器中的网页保持同步。

解决：网络内容发生变化时，将新的网络内容从服务器直接传送到缓存服务器，或者当网络内容增加时，尽可能的将数据源服务器的内容尽可能复制到缓存服务器

## 前端 CDN

不足：

- 开发阶段断网，无法加载
- 不够灵活。只使用 jquery 库的一小部分，如果使用 CDN 上提供的文件就没办法进行拆分，还是得下载原来的大小，反而没有自己拆分后加载速度来得快
- 由于地理、法律、政策和商业上的阻隔，所在地区可能屏蔽了一些流行的免费 CDN 服务的域名或者 IP 地址
- CDN 会有出故障的时候
- 安全性对网站很重要，就不要使用公共的 CDN
  考量是否需要用 CDN
- 不该用：
  - 内部网络应用，不予外部 internet 链接
  - 银行系统这样的应用，安全和隐私最优先考虑
  - 为公司或国家开发的应用，而他们恰好对某些 CDN 的域名或者 IP 地址限制访问
- 低流量的小网站不需要用
- 对流量高的网站，CDN 可以大大提升性能，但用户以移动设备为主，自己优化过的小文件比 CDN 上的大文件要下载和执行的更快
- 对于重要文件，最好提供本地文件的冗余，以应对 CDN 文件不可用的情况

```javascript
<script src="https://ajax.googleapis.com/ajax/libs/jquery1.4.3/jquery.min.js"></script>
<script>!window.jQuery && document.write("<script src=\"scripts/jquery-1.4.3.min.js\">" + "<\/scrript>")
```

## 三、总结

`CDN` 目的是为了改善互联网的服务质量，通俗一点说其实就是提高访问速度

`CDN` 构建了全国、全球级别的专网，让用户就近访问专网里的边缘节点，降低了传输延迟，实现了网站加速

通过`CDN`的负载均衡系统，智能调度边缘节点提供服务，相当于`CDN`服务的大脑，而缓存系统相当于`CDN`的心脏，缓存命中直接返回给用户，否则回源

## 参考文献

- https://zh.wikipedia.org/wiki/內容傳遞網路
- https://juejin.cn/post/6844903890706661389#heading-5
- https://blog.csdn.net/lxx309707872/article/details/109078783
